<!--Static table from csv file-->
<table id="datatable" class="display">
	<thead>
		<tr>
			{% for pair in site.data.database[0] %}
				<th>{{ pair[0] }}</th>
			{% endfor %}
		</tr>
	</thead>
	<tbody>
	{% for row in site.data.database %}
		<tr>
			{% for pair in row %}
				<td>{{ pair[1] }}</td>
			{% endfor %}
		</tr>
	{% endfor %}
	</tbody>
</table>

<br>
<div id="inspireApiContent"></div>

<!--Dynamic table using js-->
<style>
.bib-highlight {
	background-color: #ffffe0;
	border: 2px solid #ffcc00;
	padding: 10px;
	transition: background-color 0.5s ease-out, border-color 0.5s ease-out;
}
</style>
<script>
var currentColumnUnits = {};
$(document).ready(function() {

	//Columns with LaTeX number rendering
	var numberColumnIndexes = [3, 4, 5];
	
	//Columns with inspire ids
	var inspireColumnIndexes = [6];

	//Columns with filter button
	var filterColumnIndexes = [0, 1, 2];
	
	//Number of rows entries per page
	var rowsPerPage = 30;
	
	//Display numbers as LaTeX
	function displayLatexNumber(num, precision = 2) {
		if (num === 0) {
			return "$0$";
		}

		const expStr = num.toExponential(precision); 
		const parts = expStr.split('e');
		let mantissa = parts[0];
		let exponent = parseInt(parts[1], 10);
		
		if (exponent === 0) {
			return `$${mantissa}$`;
		}
		
		return `$${mantissa} \\times 10^{${exponent}}$`;
	}

	//Dynamic table rendering
	var table = $('#datatable').DataTable({
		
		"lengthChange": false,
		"pageLength": rowsPerPage,
		"searching": true,
		
		layout: {
			topStart: 'search',
			topEnd: {
				buttons: [
					{
						extend: 'csv',
						exportOptions: {
							 orthogonal: 'export'
						},
						fieldBoundary: '',
						fieldSeparator: ', '
					},
					{
						extend: 'excel',
						exportOptions: {
							 orthogonal: 'export'
						}
					},
					{
						extend: 'pdf',
						exportOptions: {
							 orthogonal: 'export'
						}
					},
					{
						text: 'Generate bibliography',
						action: function ( e, dt, button, config ) {
							var recids = [];
							var inspireColIdx = inspireColumnIndexes[0];
							
							dt.rows({ search: 'applied' }).every(function () {
								var data = this.data();
								recids.push(data[inspireColIdx]);
							});
							
							if (recids.length === 0) {
								alert('No filtered rows to generate an Inspire API URL.');
								return;
							}
							
							var queryString = recids.map(recid => `recid:${recid}`).join(' OR ');
							var encodedQueryString = encodeURIComponent(queryString);
							
							var inspireApiUrl = `https://inspirehep.net/api/literature/?q=${encodedQueryString}&format=cv`;
							
							$.ajax({
								url: inspireApiUrl,
								method: 'GET',
								success: function(responseHtml) {
									var tempDiv = $('<div>').html(responseHtml);
									var processedHtml = '';
									var currentEntryDiv = null;
									
									tempDiv.contents().each(function(index, element) {
										var $element = $(element);
										if ($element.is('p') && $element.find('b a[href*="inspirehep.net/literature/"]').length) {
											
											if (currentEntryDiv) {
												processedHtml += currentEntryDiv.prop('outerHTML');
											}
											
											var href = $element.find('a').attr('href');
											var match = href.match(/literature\/(\d+)$/);
											var recid = match ? match[1] : 'unknown';
											
											currentEntryDiv = $('<div>').attr('id', 'bib-recid-' + recid);
											currentEntryDiv.append($element.clone());
											
										} else if (currentEntryDiv) {
											
											currentEntryDiv.append($element.clone());
											
										}
									});
									
									if (currentEntryDiv) {
										processedHtml += currentEntryDiv.prop('outerHTML');
									}
									
									$('#inspireApiContent').html(processedHtml);
									
									var api = $('#datatable').DataTable();
									var inspireColIdx = inspireColumnIndexes[0];
									
									api.rows({ search: 'applied' }).every(function () {
										var rowNode = this.node();
										var rowData = this.data();
										var currentRecid = rowData[inspireColIdx];
										var cell = $(rowNode).find('td').eq(inspireColIdx); 
										if (currentRecid && $('#bib-recid-' + currentRecid).length) {
											cell.html(`<a href="#bib-recid-${currentRecid}">${currentRecid}</a>`);
										} else {
											cell.html(currentRecid);
										}
									});
									
								},
								error: function(jqXHR, textStatus, errorThrown) {
									console.error('Error fetching Inspire API content:', textStatus, errorThrown, jqXHR);
									$('#inspireApiContent').html('<p style="color: red;">Failed to load content. Please check the console for errors. Status: ' + textStatus + '</p>');
								}
							});
						}
					}
				]
			},
			bottomStart: 'info',
			bottomEnd: 'paging'
		},
		
		"columnDefs": [
			{	//Rendering for number columns
				"targets": numberColumnIndexes,
				"type": "num",
				"render": function (data, type, row, meta) {
					let numericData = parseFloat(data);
					
					if (isNaN(numericData)) {
						return data;
					}
					
					let colIdx = meta.col;
					let activeUnit = currentColumnUnits[colIdx] || { value: 1, label: 'Error unit' };
					let displayedValue = numericData * activeUnit.value;

					if (type === 'display') {
						return displayLatexNumber(displayedValue, 2);
					} else if (type === 'export') {
						return displayedValue.toExponential(2);
					}
					
                    return data;
				}
			}
		],
		
		//To update LaTeX number rendering
		"drawCallback": function( settings ) {
			if (typeof MathJax !== 'undefined' && typeof MathJax.typesetPromise !== 'undefined') {
				MathJax.typesetPromise();
			}
		},

		initComplete: function () {
		
			var api = this.api();
			var thead = $(api.table().header());
			var filterRow = $('<tr>').appendTo(thead);

			api.columns().every(function (colIdx) {
				var column = this;
				var headerText = $(column.header()).text();
				var filterCell = $('<th>').appendTo(filterRow);

				if (filterColumnIndexes.includes(colIdx)) {
					var select = $('<select><option value="">All ' + headerText + '</option></select>')
						.appendTo(filterCell)
						.on('change', function () {
							var val = $(this).val();
							column
								.search(val ? '^' + val.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '$' : '', true, false)
								.draw();
						});
					column
						.data()
						.unique()
						.sort()
						.each(function (d, j) {
							select.append(
								'<option value="' + d + '">' + d + '</option>'
							);
						});
				} else if (numberColumnIndexes.includes(colIdx)) {
					
					const allUnitsConfig = {
						3: [
							{ value: 1, label: 'Dimensionless' }
						],
						4: [
							{ value: 1, label: 'Planck energy' },
							{ value: 1.22e28, label: 'eV' },
							{ value: 1.22e19, label: 'GeV' }
						],
						5: [
							{ value: 1, label: 'Planck energy' },
							{ value: 1.22e28, label: 'eV' },
							{ value: 1.22e19, label: 'GeV' }
						]
					};
					
					const unitsForColumn = allUnitsConfig[colIdx];
					
					if (!currentColumnUnits[colIdx]) {
						currentColumnUnits[colIdx] = unitsForColumn[0];
					}
					
					var select = $('<select>')
						.appendTo(filterCell)
						.on('change', function () {
							
							let selectedValue = parseFloat($(this).val());
							let selectedUnit = unitsForColumn.find(unit => unit.value === selectedValue);
							
							if (selectedUnit) {
								currentColumnUnits[colIdx] = selectedUnit;
							} else {
								currentColumnUnits[colIdx] = { value: 1, label: 'Error Unit' };
							}
							
							console.log("Updated currentColumnUnits for column", colIdx, ":", currentColumnUnits[colIdx]);
							column.invalidate('data').draw(); 
							console.log("Column redraw triggered for column:", colIdx);
														
						});
					
						unitsForColumn.forEach(unit => {
							select.append(`<option value="${unit.value}" ${unit.value === currentColumnUnits[colIdx].value ? 'selected' : ''}>${unit.label}</option>`);
						});
					
				} else {
					
					filterCell.html('&nbsp;');
					
				}
			});
		}

 	});
 
 });
 
$(document).on('click', 'a[href^="#bib-recid-"]', function (e) {
	e.preventDefault();
    
	var targetId = this.getAttribute('href');
	var $target = $(targetId);

	if ($target.length) {

		$('.bib-highlight').removeClass('bib-highlight');

		$('html, body').animate({
			scrollTop: $target.offset().top - 50 // adjust offset if needed
		}, 300, function () {
			$target.addClass('bib-highlight');
			setTimeout(() => {
				$target.removeClass('bib-highlight');
			}, 1500);
		});
	}
});
</script>
