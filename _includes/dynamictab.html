<!--Static table from csv file-->

{% assign numericColumnIndices = "3,4,5" | split: "," %}
{% assign inspireColumnIndices = "6" | split: "," %}

<table id="datatable" class="display">
	<thead>
		<tr>
		{% for pair in site.data.database[0] %}
			<th>{{ pair[0] }}</th>
		{% endfor %}
		</tr>
	</thead>
	<tbody>
	{% for row in site.data.database %}
		<tr>
		{% for pair in row %}
			{% assign colIdx = forloop.index0 %}
			{% assign cellClass = "string" %}
			
			{% if numericColumnIndices contains colIdx %}
				{% assign cellClass = "number" %}
			{% endif %}
			
			{% if inspireColumnIndices contains colIdx %}
				{% assign cellClass = "inspire" %}
			{% endif %}
			
			<td class="{{ cellClass }}">{{ pair[1] }}</td>
		{% endfor %}
		</tr>
	{% endfor %}
	</tbody>
</table>

<!--Dynamic table using js-->
<script>
$(document).ready(function() {

	//Columns which LaTeX number rendering
	var numberColumnIndexes = [3, 4, 5];

	//Columns which filter button
	var filterColumnIndexes = [0, 1, 2];
	
	//Number of rows entries per page
	var rowsPerPage = 30;
	
	//Display numbers as LaTeX
	function formatScientific(num, precision = 2) {
		if (num === 0) {
			return "$0$"; // Return "0" within MathJax delimiters
		}

		const expStr = num.toExponential(precision); 
		const parts = expStr.split('e');
		let mantissa = parts[0];
		let exponent = parseInt(parts[1], 10);
		let exponentSign = exponent >= 0 ? '+' : '';

		return `$${mantissa} \\times 10^{${exponentSign}${exponent}}$`;
	}

	//Dynamic table rendering
	var table = $('#datatable').DataTable({
		
		"lengthChange": false,
		"pageLength": rowsPerPage,
		"searching": true,
		
		layout: {
			topStart: {
				buttons: [
					{
						extend: 'csv',
						exportOptions: {
							 orthogonal: 'export'
						},
						fieldBoundary: '',
						fieldSeparator: ', '
					},
					{
						extend: 'excel',
						exportOptions: {
							 orthogonal: 'export'
						}
					},
					{
						extend: 'pdf',
						exportOptions: {
							 orthogonal: 'export'
						}
					}
				]
			}
		},
		
	// Use the 'createdCell' callback for dynamic class-based rendering
		"createdCell": function (td, cellData, rowData, row, col) {
			// Check if the cell being created has the 'number' class
			if ($(td).hasClass('number')) {
				// Apply numeric type for sorting to this specific column
				// This ensures columns with 'number' class sort numerically
				// It's more robust to set this in a single columnDef, but this is for dynamic targeting
				this.api().column(col).type('num');

				// Apply the scientific formatting to the display data
				let numericData = parseFloat(cellData);
				if (!isNaN(numericData)) {
					// Directly update the innerHTML of the cell for display type
					// This happens AFTER DataTables has processed its internal 'data'
					$(td).html(formatScientific(numericData, 2));
				}
			}
		},
		
		"columnDefs": [
			{
				// This columnDef is mainly for 'export' type and ensuring a default for all cells
				// The actual 'display' rendering for 'number' class is handled by createdCell
				"targets": '_all', 
				"render": function (data, type, row, meta) {
					// This part handles the 'export' type for *all* columns,
					// and ensures original data is returned for other types if not modified by createdCell
					if (type === 'export') {
						// For export, return the raw numeric data if it's a number cell
						// This might still require some refinement if you have complex data types
						var cellNode = this.api().cell(meta.row, meta.col).node();
						if ($(cellNode).hasClass('number')) {
							return parseFloat(data); // Return raw number for export
						}
						return data; // For non-number cells, return original data
					}
					return data; // Return original data for 'display' type, as createdCell will format it
				}
			}
		],
		
		//To update LaTeX number rendering
		"drawCallback": function( settings ) {
			if (typeof MathJax !== 'undefined' && typeof MathJax.typesetPromise !== 'undefined') {
				MathJax.typesetPromise();
			}
		},

		initComplete: function () {
		
			var api = this.api();
			var thead = $(api.table().header());
			var filterRow = $('<tr>').appendTo(thead);

			api.columns().every(function (colIdx) {
				var column = this;
				var headerText = $(column.header()).text();
				var filterCell = $('<th>').appendTo(filterRow);

				if (filterColumnIndexes.includes(colIdx)) {
					var select = $('<select><option value="">All ' + headerText + '</option></select>')
						.appendTo(filterCell)
						.on('change', function () {
							var val = $(this).val();
							column
								.search(val ? '^' + val + '$' : '', true, false)
								.draw();
						});
					column
						.data()
						.unique()
						.sort()
						.each(function (d, j) {
							select.append(
								'<option value="' + d + '">' + d + '</option>'
							);
						});
				} else {
					filterCell.html('&nbsp;');
				}
			});
		}

 	});
 
 });
</script>
